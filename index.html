<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
  <title>èšåˆç‚¹æ™ºèƒ½æ”¾å¤§ - V4å¯é…ç½®ç‰ˆ</title>
  
  <!-- ArcGIS Maps SDK for JavaScript -->
  <link rel="stylesheet" href="https://js.arcgis.com/4.28/esri/themes/light/main.css" />
  <script src="https://js.arcgis.com/4.28/"></script>
  
  <style>
    html,
    body,
    #viewDiv {
      padding: 0;
      margin: 0;
      height: 100%;
      width: 100%;
    }
    
    /* ä½¿ç”¨è¯´æ˜ - å·¦ä¸Šè§’ */
    #infoPanel {
      position: absolute;
      top: 15px;
      left: 15px;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      font-family: Arial, sans-serif;
      z-index: 99;
      max-width: 280px;
      padding: 12px 15px;
    }
    
    #infoPanel h3 {
      margin: 0 0 8px 0;
      font-size: 15px;
      color: #333;
    }
    
    #infoPanel p {
      margin: 4px 0;
      font-size: 12px;
      color: #666;
      line-height: 1.4;
    }
    
    /* æ§åˆ¶é¢æ¿ - å³ä¸Šè§’ */
    #controlPanel {
      position: absolute;
      top: 200px;
      left: 15px;
      background-color: white;
      border-radius: 8px;
      box-shadow: 0 2px 6px rgba(0,0,0,0.3);
      font-family: Arial, sans-serif;
      z-index: 99;
      max-width: 340px;
    }
    
    .panel-header {
      background: linear-gradient(135deg, #0066cc, #0099ff);
      color: white;
      padding: 12px 15px;
      border-radius: 8px 8px 0 0;
      font-weight: bold;
      font-size: 15px;
    }
    
    .panel-body {
      padding: 15px;
    }
    
    .control-group {
      margin-bottom: 15px;
    }
    
    .control-group label {
      display: block;
      font-size: 13px;
      color: #333;
      margin-bottom: 5px;
      font-weight: 500;
    }
    
    .control-group input[type="number"] {
      width: 80px;
      padding: 6px 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 14px;
    }
    
    .control-group select {
      width: 100%;
      padding: 6px 8px;
      border: 1px solid #ddd;
      border-radius: 4px;
      font-size: 13px;
    }
    
    .info-text {
      font-size: 12px;
      color: #666;
      margin-top: 3px;
      line-height: 1.4;
    }
    
    .status-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: bold;
      margin-top: 5px;
    }
    
    .status-zoom {
      background: #e3f2fd;
      color: #1976d2;
    }
    
    .status-info {
      background: #fff3e0;
      color: #f57c00;
    }
    
    .divider {
      height: 1px;
      background: #eee;
      margin: 15px 0;
    }
    
    /* Popup æ ·å¼ */
    .feature-item {
      padding: 10px;
      border-bottom: 1px solid #eee;
      cursor: pointer;
      transition: all 0.2s;
    }
    
    .feature-item:hover {
      background-color: #f0f8ff;
      padding-left: 15px;
    }
    
    .feature-item:last-child {
      border-bottom: none;
    }
    
    .feature-number {
      display: inline-block;
      background: #0066cc;
      color: white;
      width: 24px;
      height: 24px;
      line-height: 24px;
      text-align: center;
      border-radius: 50%;
      font-size: 12px;
      margin-right: 8px;
      font-weight: bold;
    }
    
    @media (max-width: 768px) {
      #controlPanel {
        max-width: calc(100% - 30px);
        top: auto;
        bottom: 15px;
      }
      #infoPanel {
        max-width: calc(100% - 30px);
      }
    }
  </style>

  <script>
    require([
      "esri/WebMap",
      "esri/views/MapView",
      "esri/core/reactiveUtils",
      "esri/geometry/geometryEngine"
    ], function(WebMap, MapView, reactiveUtils, geometryEngine) {

      // ========================================
      // âš™ï¸ é…ç½®å‚æ•°
      // ========================================
      let CONFIG = {
        maxZoomLevel: 16,        // æœ€å¤§ç¼©æ”¾çº§åˆ«
        zoomIncrement: 2,        // æ¯æ¬¡æ”¾å¤§çš„çº§åˆ«å¢é‡
        animationDuration: 1000, // åŠ¨ç”»æŒç»­æ—¶é—´ï¼ˆæ¯«ç§’ï¼‰
        extendFactor: 1.5,       // èŒƒå›´æ‰©å±•ç³»æ•°
        maxFeaturesInPopup: 50,  // Popupä¸­æœ€å¤šæ˜¾ç¤ºçš„è¦ç´ æ•°
        bufferDistance: 100      // ç©ºé—´æŸ¥è¯¢ç¼“å†²è·ç¦»ï¼ˆç±³ï¼‰
      };
      
      const webmap = new WebMap({
        portalItem: {
          id: "08bde04a3f5b42afbf91156c57182c30"
        }
      });

      const view = new MapView({
        container: "viewDiv",
        map: webmap,
        popup: {
          dockEnabled: true,
          dockOptions: {
            buttonEnabled: true,
            breakpoint: false,
            position: "top-right"
          }
        }
      });

      view.when(function() {
        console.log("âœ… åœ°å›¾åŠ è½½å®Œæˆ");
        
        initControlPanel();
        
        webmap.layers.forEach(function(layer) {
          console.log("ğŸ“‚ å›¾å±‚:", layer.title, "| ç±»å‹:", layer.type);
          if (layer.featureReduction && layer.featureReduction.type === "cluster") {
            console.log("ğŸ¯ æ‰¾åˆ°èšåˆå›¾å±‚:", layer.title);
            setupClusterClickHandler(layer);
          }
        });
      });

      function initControlPanel() {
        const maxZoomInput = document.getElementById("maxZoomLevel");
        const zoomIncrementInput = document.getElementById("zoomIncrement");
        const bufferInput = document.getElementById("bufferDistance");
        const behaviorSelect = document.getElementById("behaviorMode");
        
        maxZoomInput.value = CONFIG.maxZoomLevel;
        zoomIncrementInput.value = CONFIG.zoomIncrement;
        bufferInput.value = CONFIG.bufferDistance;
        
        maxZoomInput.addEventListener("change", function() {
          CONFIG.maxZoomLevel = parseFloat(this.value);
          console.log("âš™ï¸ æœ€å¤§ç¼©æ”¾çº§åˆ«è®¾ä¸º:", CONFIG.maxZoomLevel);
          updateStatus();
        });
        
        zoomIncrementInput.addEventListener("change", function() {
          CONFIG.zoomIncrement = parseFloat(this.value);
          console.log("âš™ï¸ æ”¾å¤§å¢é‡è®¾ä¸º:", CONFIG.zoomIncrement);
        });
        
        bufferInput.addEventListener("change", function() {
          CONFIG.bufferDistance = parseFloat(this.value);
          console.log("âš™ï¸ ç¼“å†²è·ç¦»è®¾ä¸º:", CONFIG.bufferDistance, "ç±³");
        });
        
        behaviorSelect.addEventListener("change", function() {
          if (this.value === "always-zoom") {
            CONFIG.maxZoomLevel = 99;
          } else if (this.value === "always-info") {
            CONFIG.maxZoomLevel = 0;
          } else {
            CONFIG.maxZoomLevel = parseFloat(maxZoomInput.value);
          }
          console.log("âš™ï¸ è¡Œä¸ºæ¨¡å¼:", this.value);
          updateStatus();
        });
      }

      function updateStatus() {
        const currentZoom = view.zoom;
        const statusDiv = document.getElementById("currentStatus");
        
        if (currentZoom >= CONFIG.maxZoomLevel) {
          statusDiv.innerHTML = '<span class="status-badge status-info">ğŸ“‹ ç‚¹å‡»æ˜¾ç¤ºè¯¦æƒ…</span>';
        } else {
          statusDiv.innerHTML = '<span class="status-badge status-zoom">ğŸ” ç‚¹å‡»æ”¾å¤§åœ°å›¾</span>';
        }
      }

      function setupClusterClickHandler(layer) {
        view.on("click", function(event) {
          view.hitTest(event).then(function(response) {
            const clusterResult = response.results.find(function(result) {
              return result.graphic && result.graphic.layer === layer;
            });

            if (clusterResult) {
              const graphic = clusterResult.graphic;
              
              if (graphic.isAggregate) {
                const clusterCount = graphic.attributes.cluster_count;
                const currentZoom = view.zoom;
                
                console.log("ğŸ“ ç‚¹å‡»èšåˆç‚¹ | åŒ…å«:", clusterCount, "ä¸ªè¦ç´  | ç¼©æ”¾:", currentZoom.toFixed(2));
                
                event.stopPropagation();
                
                if (currentZoom >= CONFIG.maxZoomLevel) {
                  showClusterInfo(graphic, layer);
                } else {
                  zoomToCluster(graphic, layer);
                }
              } else {
                console.log("ğŸ“Œ ç‚¹å‡»äº†å•ä¸ªè¦ç´ ");
                event.stopPropagation();
                showSingleFeatureInfo(graphic);
              }
            }
          });
        });
        
        view.on("pointer-move", function(event) {
          view.hitTest(event).then(function(response) {
            const clusterResult = response.results.find(function(result) {
              return result.graphic && result.graphic.layer === layer;
            });
            
            if (clusterResult) {
              view.container.style.cursor = "pointer";
            } else {
              view.container.style.cursor = "default";
            }
          });
        });
      }

      // ğŸ”§ V4ä¿®å¤ï¼šåŒé‡æŸ¥è¯¢ç­–ç•¥
      function showClusterInfo(clusterGraphic, layer) {
        console.log("ğŸ” å¼€å§‹æŸ¥è¯¢èšåˆå†…çš„è¦ç´ ...");
        console.log("èšåˆç‚¹ä½ç½®:", clusterGraphic.geometry.longitude, clusterGraphic.geometry.latitude);
        console.log("èšåˆç‚¹å£°ç§°åŒ…å«:", clusterGraphic.attributes.cluster_count, "ä¸ªè¦ç´ ");
        
        const query1 = layer.createQuery();
        query1.aggregateIds = [clusterGraphic.getObjectId()];
        
        layer.queryFeatures(query1).then(function(result) {
          console.log("ğŸ“Š æ–¹æ³•1 (aggregateIds) è¿”å›:", result.features.length, "ä¸ªè¦ç´ ");
          
          const expectedCount = clusterGraphic.attributes.cluster_count;
          
          if (result.features.length === expectedCount || 
              (result.features.length > 0 && result.features.length < expectedCount * 2)) {
            console.log("âœ… ä½¿ç”¨æ–¹æ³•1çš„ç»“æœ");
            displayClusterFeatures(result.features, clusterGraphic);
          } else {
            console.log("âš ï¸ æ–¹æ³•1è¿”å›çš„æ•°é‡ä¸å¯¹ï¼Œå°è¯•æ–¹æ³•2 (ç©ºé—´æŸ¥è¯¢)");
            queryByGeometry(clusterGraphic, layer);
          }
        }).catch(function(error) {
          console.error("âŒ æ–¹æ³•1å¤±è´¥:", error);
          console.log("å°è¯•æ–¹æ³•2 (ç©ºé—´æŸ¥è¯¢)");
          queryByGeometry(clusterGraphic, layer);
        });
      }
      
      function queryByGeometry(clusterGraphic, layer) {
        const point = clusterGraphic.geometry;
        const bufferDistance = CONFIG.bufferDistance;
        
        console.log("ğŸ” ä½¿ç”¨ç©ºé—´æŸ¥è¯¢ï¼Œç¼“å†²è·ç¦»:", bufferDistance, "ç±³");
        
        const query2 = layer.createQuery();
        query2.geometry = point;
        query2.distance = bufferDistance;
        query2.units = "meters";
        query2.spatialRelationship = "intersects";
        query2.returnGeometry = true;
        
        layer.queryFeatures(query2).then(function(result) {
          console.log("ğŸ“Š æ–¹æ³•2 (ç©ºé—´æŸ¥è¯¢) è¿”å›:", result.features.length, "ä¸ªè¦ç´ ");
          
          if (result.features.length > 0) {
            displayClusterFeatures(result.features, clusterGraphic);
          } else {
            view.popup.open({
              title: "âš ï¸ æ— æ³•åŠ è½½è¯¦ç»†ä¿¡æ¯",
              content: "è¯¥èšåˆç‚¹åŒ…å« " + clusterGraphic.attributes.cluster_count + " ä¸ªä½ç½®ï¼Œä½†æ— æ³•æŸ¥è¯¢åˆ°è¯¦ç»†æ•°æ®ã€‚",
              location: clusterGraphic.geometry
            });
          }
        }).catch(function(error) {
          console.error("âŒ æ–¹æ³•2ä¹Ÿå¤±è´¥:", error);
          view.popup.open({
            title: "âš ï¸ æŸ¥è¯¢å¤±è´¥",
            content: "æ— æ³•è·å–èšåˆç‚¹çš„è¯¦ç»†ä¿¡æ¯ã€‚é”™è¯¯: " + error.message,
            location: clusterGraphic.geometry
          });
        });
      }
      
      function displayClusterFeatures(features, clusterGraphic) {
        console.log("âœ… å‡†å¤‡æ˜¾ç¤º", features.length, "ä¸ªè¦ç´ ");
        const popupContent = createClusterPopupContent(features);
        view.popup.open({
          title: "ğŸ“ èšåˆç‚¹è¯¦æƒ… (" + features.length + " ä¸ªä½ç½®)",
          content: popupContent,
          location: clusterGraphic.geometry
        });
      }
      
      function showSingleFeatureInfo(graphic) {
        console.log("ğŸ“‹ æ˜¾ç¤ºå•ä¸ªè¦ç´ è¯¦ç»†ä¿¡æ¯");
        const detailContent = createSingleFeatureContent(graphic);
        view.popup.open({
          title: "ğŸ“ ä½ç½®è¯¦æƒ…",
          content: detailContent,
          location: graphic.geometry
        });
      }

      function createClusterPopupContent(features) {
        const container = document.createElement("div");
        container.style.maxHeight = "400px";
        container.style.overflowY = "auto";
        
        const summary = document.createElement("div");
        summary.style.padding = "12px";
        summary.style.backgroundColor = "#f0f8ff";
        summary.style.marginBottom = "10px";
        summary.style.borderRadius = "4px";
        summary.style.textAlign = "center";
        summary.innerHTML = "<strong style='font-size: 16px;'>ğŸ“Š " + features.length + " ä¸ªä½ç½®</strong>";
        container.appendChild(summary);
        
        const displayFeatures = features.slice(0, CONFIG.maxFeaturesInPopup);
        
        displayFeatures.forEach(function(feature, index) {
          const item = document.createElement("div");
          item.className = "feature-item";
          
          let content = "<span class='feature-number'>" + (index + 1) + "</span>";
          content += "<strong style='vertical-align: middle;'>ä½ç½® " + (index + 1) + "</strong><br>";
          
          const attrs = feature.attributes;
          let attrCount = 0;
          for (let key in attrs) {
            if (attrs.hasOwnProperty(key) && 
                key !== "OBJECTID" && 
                key !== "Shape" &&
                key !== "FID" &&
                attrs[key] !== null && 
                attrs[key] !== undefined && 
                attrs[key] !== "") {
              content += "<small>" + key + ": " + attrs[key] + "</small><br>";
              attrCount++;
              if (attrCount >= 3) break;
            }
          }
          
          if (feature.geometry) {
            content += "<small style='color: #999;'>ğŸ“ " + 
                      feature.geometry.longitude.toFixed(5) + ", " + 
                      feature.geometry.latitude.toFixed(5) + "</small>";
          }
          
          item.innerHTML = content;
          item.addEventListener("click", function() {
            highlightFeature(feature);
          });
          
          container.appendChild(item);
        });
        
        if (features.length > CONFIG.maxFeaturesInPopup) {
          const more = document.createElement("div");
          more.style.padding = "10px";
          more.style.textAlign = "center";
          more.style.color = "#999";
          more.innerHTML = "... è¿˜æœ‰ " + (features.length - CONFIG.maxFeaturesInPopup) + " ä¸ªä½ç½®";
          container.appendChild(more);
        }
        
        return container;
      }

      function highlightFeature(feature) {
        if (feature.geometry) {
          view.goTo({
            center: feature.geometry,
            zoom: Math.max(view.zoom, 18),
            duration: 800
          }).then(function() {
            const detailContent = createSingleFeatureContent(feature);
            view.popup.close();
            setTimeout(function() {
              view.popup.open({
                title: "ğŸ“ ä½ç½®è¯¦æƒ…",
                content: detailContent,
                location: feature.geometry
              });
            }, 500);
          });
        }
      }
      
      function createSingleFeatureContent(feature) {
        const container = document.createElement("div");
        container.style.padding = "10px";
        container.style.maxHeight = "400px";
        container.style.overflowY = "auto";
        
        const attrs = feature.attributes;
        let hasContent = false;
        
        for (let key in attrs) {
          if (attrs.hasOwnProperty(key)) {
            const value = attrs[key];
            
            if (key === "OBJECTID" || key === "Shape" || key === "FID") {
              continue;
            }
            
            if (value !== null && value !== undefined && value !== "") {
              hasContent = true;
              
              const row = document.createElement("div");
              row.style.marginBottom = "8px";
              row.style.paddingBottom = "8px";
              row.style.borderBottom = "1px solid #eee";
              
              const label = document.createElement("div");
              label.style.fontWeight = "bold";
              label.style.color = "#333";
              label.style.fontSize = "13px";
              label.style.marginBottom = "3px";
              label.textContent = key;
              
              const valueDiv = document.createElement("div");
              valueDiv.style.color = "#666";
              valueDiv.style.fontSize = "14px";
              valueDiv.textContent = value;
              
              row.appendChild(label);
              row.appendChild(valueDiv);
              container.appendChild(row);
            }
          }
        }
        
        if (!hasContent) {
          const noData = document.createElement("div");
          noData.style.color = "#999";
          noData.style.textAlign = "center";
          noData.style.padding = "20px";
          noData.textContent = "è¯¥ä½ç½®æ²¡æœ‰è¯¦ç»†ä¿¡æ¯";
          container.appendChild(noData);
        }
        
        if (feature.geometry) {
          const coordDiv = document.createElement("div");
          coordDiv.style.marginTop = "10px";
          coordDiv.style.paddingTop = "10px";
          coordDiv.style.borderTop = "2px solid #0066cc";
          coordDiv.style.fontSize = "12px";
          coordDiv.style.color = "#999";
          coordDiv.innerHTML = "<strong>ğŸ“ åæ ‡ä½ç½®</strong><br>" +
                              "ç»åº¦: " + feature.geometry.longitude.toFixed(6) + "<br>" +
                              "çº¬åº¦: " + feature.geometry.latitude.toFixed(6);
          container.appendChild(coordDiv);
        }
        
        return container;
      }

      function zoomToCluster(clusterGraphic, layer) {
        const query = layer.createQuery();
        query.aggregateIds = [clusterGraphic.getObjectId()];
        
        layer.queryFeatures(query).then(function(result) {
          console.log("ğŸ“Š æ”¾å¤§ï¼šèšåˆç‚¹åŒ…å«", result.features.length, "ä¸ªè¦ç´ ");
          
          if (result.features.length > 0) {
            let extent = null;
            result.features.forEach(function(feature) {
              if (feature.geometry) {
                if (!extent) {
                  extent = feature.geometry.extent.clone();
                } else {
                  extent = extent.union(feature.geometry.extent);
                }
              }
            });
            
            if (extent) {
              extent = extent.expand(CONFIG.extendFactor);
              view.goTo({
                target: extent,
                duration: CONFIG.animationDuration
              }).catch(function(error) {
                if (error.name !== "AbortError") {
                  console.error("âŒ æ”¾å¤§å¤±è´¥:", error);
                }
              });
            }
          }
        }).catch(function(error) {
          console.error("âŒ æŸ¥è¯¢èšåˆè¦ç´ å¤±è´¥:", error);
          if (clusterGraphic.geometry) {
            view.goTo({
              center: clusterGraphic.geometry,
              zoom: view.zoom + CONFIG.zoomIncrement,
              duration: CONFIG.animationDuration
            });
          }
        });
      }

      reactiveUtils.watch(
        () => view.zoom,
        (zoom) => {
          document.getElementById("currentZoom").textContent = zoom.toFixed(1);
          updateStatus();
        }
      );
    });
  </script>
</head>

<body>
  <div id="viewDiv"></div>
  
  <!-- ä½¿ç”¨è¯´æ˜ - å·¦ä¸Šè§’ -->
  <div id="infoPanel">
    <h3>ğŸ¯ ä½¿ç”¨è¯´æ˜</h3>
    <p>â€¢ ç‚¹å‡»èšåˆæ•°å­—å¯æ”¾å¤§åœ°å›¾</p>
    <p>â€¢ åˆ°è¾¾ç¼©æ”¾çº§åˆ«åæ˜¾ç¤ºè¯¦æƒ…</p>
    <p>â€¢ ç‚¹å‡»åˆ—è¡¨é¡¹æŸ¥çœ‹è¯¥ä½ç½®è¯¦æƒ…</p>
    <p>â€¢ ç‚¹å‡»å•ä¸ªç‚¹æ˜¾ç¤ºè¯¥ç‚¹è¯¦æƒ…</p>
  </div>
  
  <!-- æ§åˆ¶é¢æ¿ - å³ä¸Šè§’ -->
  <div id="controlPanel">
    <div class="panel-header">
      âš™ï¸ å‚æ•°é…ç½® - V4
    </div>
    <div class="panel-body">
      <div class="control-group">
        <label>å½“å‰ç¼©æ”¾çº§åˆ«</label>
        <div style="font-size: 20px; font-weight: bold; color: #0066cc;">
          <span id="currentZoom">--</span>
        </div>
        <div id="currentStatus" style="margin-top: 5px;">
          <span class="status-badge status-zoom">ğŸ” ç‚¹å‡»æ”¾å¤§åœ°å›¾</span>
        </div>
      </div>
      
      <div class="divider"></div>
      
      <div class="control-group">
        <label>è¡Œä¸ºæ¨¡å¼</label>
        <select id="behaviorMode">
          <option value="smart">æ™ºèƒ½æ¨¡å¼ï¼ˆæ¨èï¼‰</option>
          <option value="always-zoom">æ€»æ˜¯æ”¾å¤§</option>
          <option value="always-info">æ€»æ˜¯æ˜¾ç¤ºä¿¡æ¯</option>
        </select>
        <div class="info-text">
          æ™ºèƒ½æ¨¡å¼ï¼šåˆ°è¾¾æŒ‡å®šçº§åˆ«åæ˜¾ç¤ºä¿¡æ¯
        </div>
      </div>
      
      <div class="control-group">
        <label>æœ€å¤§ç¼©æ”¾çº§åˆ«ï¼ˆæ™ºèƒ½æ¨¡å¼ï¼‰</label>
        <input type="number" id="maxZoomLevel" min="10" max="20" step="0.5" value="16">
        <div class="info-text">
          è¶…è¿‡æ­¤çº§åˆ«åï¼Œç‚¹å‡»æ˜¾ç¤ºè¯¦æƒ…
        </div>
      </div>
      
      <div class="control-group">
        <label>æ¯æ¬¡æ”¾å¤§çº§åˆ«</label>
        <input type="number" id="zoomIncrement" min="1" max="5" step="0.5" value="2">
        <div class="info-text">
          ç‚¹å‡»èšåˆç‚¹æ—¶ï¼Œåœ°å›¾æ”¾å¤§çš„çº§æ•°
        </div>
      </div>
      
      <div class="control-group">
        <label>ç©ºé—´æŸ¥è¯¢ç¼“å†²è·ç¦»ï¼ˆç±³ï¼‰</label>
        <input type="number" id="bufferDistance" min="50" max="1000" step="50" value="100">
        <div class="info-text">
          ç”¨äºèšåˆç‚¹æŸ¥è¯¢çš„ç¼“å†²åŒºåŠå¾„
        </div>
      </div>
      
      <div class="divider"></div>
      
      <div class="info-text" style="margin: 0;">
        ğŸ’¡ <strong>V4æ–°ç‰¹æ€§ï¼š</strong>åŒé‡æŸ¥è¯¢ç­–ç•¥ç¡®ä¿æ˜¾ç¤ºæ­£ç¡®æ•°é‡
      </div>
    </div>
  </div>
</body>
</html>
